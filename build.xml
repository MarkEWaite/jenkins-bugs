<project name="JENKINS-43687" default="increment" basedir=".">

  <property environment="env"/>
  <condition property="changeLogCount" value="${env.CHANGESET_SIZE}" else="0">
    <isset property="env.CHANGESET_SIZE"/>
  </condition>

  <target name="increment" description="Increment build number">
    <echo>java is ${java.version}</echo>
    <exec executable="/bin/sh">
      <arg value="./remove-remotes.sh"/>
    </exec>
    <buildnumber/>
    <git command="commit">
      <args>
        <arg value="-m"/>
        <arg value="${ant.project.name} ${user.name} buildnumber++, was ${build.number}"/>
        <arg value="build.number"/>
      </args>
    </git>
  </target>

  <!-- Info about this repository -->
  <target name="info" description="Report info about this repo">
    <echo>java is ${java.version}</echo>
    <echo>user dir is ${user.dir}</echo>
    <git command="branch" />
    <!-- JENKINS-43687 reports that polling configured from inside
         Jenkinsfile does not detect changes in the branch.
         This job does not show the bug, but it sometimes shows that the job
         builds repeatedly even if no changes are made to the repo.
         -->
    <echo>Displaying ${changeLogCount} git log messages in changeset for this build - CHANGESET_SIZE=${env.CHANGESET_SIZE}</echo>
    <git command="log">
      <args>
        <arg value="-n"/>
        <arg value="${changeLogCount}"/>
      </args>
    </git>
    <echo>End of ${changeLogCount} git log messages in changeset for this build</echo>
  </target>

  <!-- From https://gist.github.com/davejlong/874521 -->
  <macrodef name="git">
    <attribute name="command" />
    <attribute name="dir" default="" />
    <element name="args" optional="true" />
    <sequential>
      <echo message="git @{command}" />
      <exec executable="git" dir="@{dir}">
        <arg value="@{command}" />
        <args/>
      </exec>
    </sequential>
  </macrodef>

</project>
