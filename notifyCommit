#!/bin/bash

usage() { echo "Usage: $0 [-s jenkins_server_url] [-u git_repo_url]" 1>&2; exit 1; }

SERVER=
GIT_URL=

while getopts ":s:u:" o; do
    case "${o}" in
        s)
            SERVER=${OPTARG}
            ;;
        u)
            GIT_URL=${OPTARG}
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

# Assure URL of Jenkins server is set

if [ -z "$SERVER" ]; then
    SERVER=$JENKINS_URL
fi
if [ -z "$SERVER" ]; then
    usage
fi

# Assure URL of git repository is set

if [ -n "$GIT_URL" ]; then
    echo Using GIT_URL: $GIT_URL
else
    GIT_URL=$(git remote -v | grep fetch | awk 'NR==1{print $2}')
    if [ -n "$GIT_URL" ]; then
        echo Using GIT_URL from fetch remote: $GIT_URL
    else
        GIT_URL=$(git remote -v | awk 'NR==1{print $2}')
        if [ -n "$GIT_URL" ]; then
            echo Using GIT_URL from first remote: $GIT_URL
        else
            GIT_URL=https://github.com/MarkEWaite/jenkins-bugs
            echo Using default GIT_URL: $GIT_URL
        fi
    fi
fi
if [ -z "$GIT_URL" ]; then
    usage
fi

suffix=$RANDOM

crumb_output=crumb-$suffix

echo "Querying URL=$SERVER for CSRF crumb"
crumb=$(curl -s $SERVER/crumbIssuer/api/xml?xpath=concat\(//crumbRequestField,%22:%22,//crumb\))
if [ -z "$crumb" ]; then
        echo Exiting: No crumb returned by $SERVER
        exit 2
fi
if [ ${#crumb} -gt 60 ]; then
        echo Exiting: Long crumb returned by $SERVER: $crumb
        exit 3
fi

echo "Notifying URL=$SERVER POST using crumb: $crumb"
curl -s -H "$crumb" -X POST $SERVER/git/notifyCommit?url=$GIT_URL -o $crumb_output

no_crumb_output=no-crumb-$suffix

echo "Notifying URL=$SERVER POST with no crumb"
curl -s -X POST $SERVER/git/notifyCommit?url=$GIT_URL -o $no_crumb_output
